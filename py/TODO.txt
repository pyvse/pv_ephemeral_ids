TODO: Port this properly from the JS implementation.